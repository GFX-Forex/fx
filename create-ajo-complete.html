<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Create Circle - Meritwise</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
        :root {
            --purple: #7c3aed; --purple-dark: #6d28d9; --purple-light: #ede9fe;
            --blue: #3b82f6; --blue-light: #dbeafe;
            --green: #059669; --green-light: #dcfce7;
            --red: #dc2626; --red-light: #fee2e2;
            --amber: #d97706; --amber-light: #fef3c7;
            --gray-900: #0f172a; --gray-600: #475569; --gray-400: #94a3b8; --gray-200: #e2e8f0; --gray-100: #f1f5f9;
            --white: #fff;
            --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Sora', sans-serif; background: var(--gray-100); min-height: 100vh; padding-bottom: 100px; }
        .container { max-width: 480px; margin: 0 auto; position: relative; z-index: 1; }
        
        /* Header */
        .header { position: sticky; top: 0; z-index: 100; padding: 16px 20px; background: rgba(241,245,249,0.92); backdrop-filter: blur(24px); display: flex; align-items: center; gap: 16px; border-bottom: 1px solid rgba(148,163,184,0.12); }
        .back-btn { width: 40px; height: 40px; background: var(--white); border: 1.5px solid var(--gray-200); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .back-btn:active { transform: scale(0.93); }
        .back-btn svg { width: 18px; height: 18px; stroke: var(--gray-600); }
        .header-title { flex: 1; font-size: 17px; font-weight: 700; color: var(--gray-900); }
        .badge { background: linear-gradient(135deg, var(--purple), var(--purple-dark)); color: var(--white); font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; }
        
        /* Screens */
        .screen { padding: 24px 20px; display: none; animation: slideIn 0.45s var(--spring); }
        .screen.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
        
        .eyebrow { font-size: 11px; font-weight: 700; color: var(--purple); letter-spacing: 1.2px; text-transform: uppercase; margin-bottom: 6px; }
        .headline { font-size: 22px; font-weight: 800; color: var(--gray-900); margin-bottom: 6px; }
        .sub { font-size: 13px; color: var(--gray-400); margin-bottom: 28px; line-height: 1.5; }
        
        /* Form elements */
        .label { font-size: 12px; font-weight: 700; color: var(--gray-400); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; display: block; }
        .input { width: 100%; padding: 14px 16px; background: var(--white); border: 1.5px solid var(--gray-200); border-radius: 12px; font-family: 'Sora'; font-size: 14px; font-weight: 500; color: var(--gray-900); outline: none; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: all 0.2s; }
        .input:focus { border-color: var(--purple); box-shadow: 0 0 0 4px rgba(124,58,237,0.1); }
        .input-group { margin-bottom: 20px; }
        
        /* Frequency grid */
        .freq-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 28px; }
        .freq-opt { padding: 18px 12px; background: var(--white); border: 1.5px solid var(--gray-200); border-radius: 14px; text-align: center; cursor: pointer; transition: all 0.2s var(--spring); position: relative; }
        .freq-opt:active { transform: scale(0.96); }
        .freq-opt.active { background: var(--purple-light); border-color: var(--purple); }
        .freq-opt.blocked { opacity: 0.4; cursor: not-allowed; }
        .freq-opt.blocked::after { content: 'üîí'; position: absolute; top: 8px; right: 8px; font-size: 12px; }
        .freq-icon { font-size: 28px; margin-bottom: 8px; }
        .freq-label { font-size: 13px; font-weight: 700; color: var(--gray-600); }
        .freq-opt.active .freq-label { color: var(--purple); }
        .freq-sub { font-size: 10px; color: var(--gray-400); margin-top: 4px; }
        
        /* Alert box */
        .alert { background: var(--amber-light); border: 1px solid rgba(217,119,6,0.3); border-radius: 12px; padding: 14px; margin-bottom: 20px; display: flex; gap: 10px; }
        .alert-icon { font-size: 16px; flex-shrink: 0; }
        .alert-text { font-size: 12px; color: #92400e; font-weight: 500; line-height: 1.6; }
        
        /* Search */
        .search-wrap { position: relative; margin-bottom: 20px; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; stroke: var(--gray-400); pointer-events: none; }
        .search-input { padding-left: 44px; }
        
        /* Member list */
        .member-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--white); border: 1.5px solid var(--gray-200); border-radius: 14px; margin-bottom: 10px; cursor: grab; transition: all 0.2s; }
        .member-item:active { cursor: grabbing; transform: scale(0.98); }
        .member-item.dragging { opacity: 0.5; }
        .drag-handle { font-size: 20px; color: var(--gray-400); cursor: grab; }
        .member-avatar { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 800; color: var(--white); flex-shrink: 0; }
        .member-info { flex: 1; }
        .member-name { font-size: 14px; font-weight: 700; color: var(--gray-900); }
        .member-id { font-size: 12px; color: var(--gray-400); }
        .position-badge { width: 32px; height: 32px; background: var(--purple-light); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; color: var(--purple); }
        .remove-btn { width: 28px; height: 28px; background: var(--red-light); border-radius: 8px; border: none; color: var(--red); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* User cards (search results) */
        .user-card { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--white); border: 1.5px solid var(--gray-200); border-radius: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .user-card:active { transform: scale(0.98); background: var(--purple-light); border-color: var(--purple); }
        
        /* Review card */
        .review-card { background: var(--white); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1.5px solid var(--gray-200); }
        .review-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--gray-100); }
        .review-row:last-child { border: none; }
        .review-label { font-size: 13px; color: var(--gray-400); }
        .review-value { font-size: 14px; font-weight: 700; color: var(--gray-900); text-align: right; }
        .review-value.highlight { color: var(--purple); font-size: 18px; }
        
        /* Fee breakdown */
        .fee-card { background: var(--purple-light); border-radius: 16px; padding: 16px; margin-bottom: 20px; }
        .fee-title { font-size: 12px; font-weight: 700; color: var(--purple); text-transform: uppercase; margin-bottom: 12px; }
        .fee-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .fee-label { color: var(--gray-600); }
        .fee-value { font-weight: 700; color: var(--gray-900); }
        .fee-row.total { border-top: 1px solid rgba(124,58,237,0.2); padding-top: 8px; margin-top: 8px; font-size: 15px; }
        
        /* Buttons */
        .btn-primary { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--purple), var(--purple-dark)); color: var(--white); border: none; border-radius: 20px; font-family: 'Sora'; font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 8px 24px rgba(124,58,237,0.35); transition: all 0.2s var(--spring); }
        .btn-primary:active { transform: scale(0.97); }
        .btn-primary:disabled { background: var(--gray-200); color: var(--gray-400); box-shadow: none; cursor: not-allowed; transform: none; }
        .btn-ghost { width: 100%; padding: 16px; background: transparent; color: var(--gray-600); border: 1.5px solid var(--gray-200); border-radius: 20px; font-family: 'Sora'; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 10px; transition: all 0.2s; }
        .btn-ghost:active { background: var(--gray-100); }
        .btn-add { width: 100%; padding: 14px; background: var(--purple-light); color: var(--purple); border: 1.5px dashed var(--purple); border-radius: 12px; font-family: 'Sora'; font-size: 14px; font-weight: 700; cursor: pointer; margin-bottom: 20px; transition: all 0.2s; }
        .btn-add:active { transform: scale(0.98); }
        
        /* Toast */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--gray-900); color: var(--white); padding: 12px 20px; border-radius: 40px; font-size: 13px; font-weight: 600; z-index: 9999; opacity: 0; transition: all 0.35s var(--spring); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Empty state */
        .empty { text-align: center; padding: 40px 20px; color: var(--gray-400); }
        .empty-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-text { font-size: 14px; font-weight: 600; }
        
        /* Color classes for avatars */
        .c-0 { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
        .c-1 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .c-2 { background: linear-gradient(135deg, #059669, #047857); }
        .c-3 { background: linear-gradient(135deg, #d97706, #b45309); }
        .c-4 { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .c-5 { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    </style>
</head>
<body>

<div class="toast" id="toast"></div>

<div class="container">
    <div class="header">
        <button class="back-btn" onclick="goBack()">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 5l-7 7 7 7"/>
            </svg>
        </button>
        <span class="header-title">Create Circle</span>
        <div class="badge" id="stepBadge">Step 1/3</div>
    </div>

    <!-- Screen 1: Basics -->
    <div class="screen active" id="screen-1">
        <div class="eyebrow">Step 1 of 3</div>
        <div class="headline">Circle Details</div>
        <div class="sub">Set contribution amount and frequency</div>

        <div class="input-group">
            <label class="label">Contribution Amount</label>
            <input class="input" type="number" id="amount" placeholder="Enter amount (e.g., 5000)" inputmode="decimal">
        </div>

        <label class="label">Contribution Frequency</label>
        <div class="freq-grid">
            <div class="freq-opt" data-freq="daily" onclick="selectFreq(this, 'daily')">
                <div class="freq-icon">‚òÄÔ∏è</div>
                <div class="freq-label">Daily</div>
                <div class="freq-sub">Every day</div>
            </div>
            <div class="freq-opt active" data-freq="weekly" onclick="selectFreq(this, 'weekly')">
                <div class="freq-icon">üìÖ</div>
                <div class="freq-label">Weekly</div>
                <div class="freq-sub">Every week</div>
            </div>
            <div class="freq-opt" data-freq="monthly" onclick="selectFreq(this, 'monthly')">
                <div class="freq-icon">üóìÔ∏è</div>
                <div class="freq-label">Monthly</div>
                <div class="freq-sub">Every month</div>
            </div>
        </div>

        <div class="alert">
            <span class="alert-icon">‚ÑπÔ∏è</span>
            <div class="alert-text">You can only have <strong>one active circle per frequency</strong>. Choose wisely!</div>
        </div>

        <div class="input-group">
            <label class="label">Circle Name</label>
            <input class="input" id="circleName" placeholder="e.g., Weekend Fund" maxlength="30">
        </div>

        <button class="btn-primary" onclick="validateStep1()">Continue</button>
    </div>

    <!-- Screen 2: Members -->
    <div class="screen" id="screen-2">
        <div class="eyebrow">Step 2 of 3</div>
        <div class="headline">Add Members</div>
        <div class="sub">Invite 3-12 people and arrange payout order</div>

        <div class="alert">
            <span class="alert-icon">üë•</span>
            <div class="alert-text"><strong>Drag to reorder</strong> ‚Äî First person gets paid first cycle, and so on.</div>
        </div>

        <div class="search-wrap">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round">
                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
            </svg>
            <input class="search-input input" id="memberSearch" placeholder="Search by name or ID" oninput="searchMembers(this.value)">
        </div>

        <div id="searchResults" style="display: none; margin-bottom: 20px;"></div>

        <label class="label">Payout Order (<span id="memberCount">0</span>/12)</label>
        <div id="membersList"></div>

        <button class="btn-primary" id="continueBtn2" onclick="goToStep(3)" disabled>Continue</button>
        <button class="btn-ghost" onclick="goToStep(1)">‚Üê Back</button>
    </div>

    <!-- Screen 3: Review -->
    <div class="screen" id="screen-3">
        <div class="eyebrow">Step 3 of 3</div>
        <div class="headline">Review & Launch</div>
        <div class="sub">Confirm all details before creating</div>

        <div class="review-card">
            <div class="review-row">
                <span class="review-label">Circle Name</span>
                <span class="review-value" id="reviewName">‚Äî</span>
            </div>
            <div class="review-row">
                <span class="review-label">Contribution Amount</span>
                <span class="review-value highlight" id="reviewAmount">‚Ç¶0</span>
            </div>
            <div class="review-row">
                <span class="review-label">Frequency</span>
                <span class="review-value" id="reviewFreq">‚Äî</span>
            </div>
            <div class="review-row">
                <span class="review-label">Total Members</span>
                <span class="review-value" id="reviewMembers">0</span>
            </div>
            <div class="review-row">
                <span class="review-label">Total Cycles</span>
                <span class="review-value" id="reviewCycles">0</span>
            </div>
        </div>

        <div class="fee-card">
            <div class="fee-title">üí∞ Payout Calculation</div>
            <div class="fee-row">
                <span class="fee-label">Total collected</span>
                <span class="fee-value" id="feeTotal">‚Ç¶0</span>
            </div>
            <div class="fee-row">
                <span class="fee-label">Platform fee (2%)</span>
                <span class="fee-value" id="feePlatform">‚Ç¶0</span>
            </div>
            <div class="fee-row total">
                <span class="fee-label">Each member receives</span>
                <span class="fee-value" id="feeNet">‚Ç¶0</span>
            </div>
        </div>

        <div class="alert">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div class="alert-text"><strong>Auto-debit warning:</strong> Members must have sufficient funds on contribution day or they'll be removed automatically.</div>
        </div>

        <button class="btn-primary" onclick="launchCircle()">Launch Circle üéØ</button>
        <button class="btn-ghost" onclick="goToStep(2)">‚Üê Edit Members</button>
    </div>
</div>

<script>
const API_BASE_URL = 'https://meritwise.app/api';

// State
const state = {
    step: 1,
    amount: 0,
    frequency: 'weekly',
    circleName: '',
    members: []
};

// Mock user data
const mockUsers = [
    { id: 'PAY123456789', name: 'Adaeze Nwosu', phone: '08012345678', colorClass: 'c-0' },
    { id: 'PAY987654321', name: 'Chioma Eze', phone: '08087654321', colorClass: 'c-1' },
    { id: 'PAY555666777', name: 'Tobi Adeleke', phone: '08055566677', colorClass: 'c-2' },
    { id: 'PAY111222333', name: 'Godwin Okafor', phone: '08011122233', colorClass: 'c-3' },
    { id: 'PAY444555666', name: 'Ngozi Obi', phone: '08044455566', colorClass: 'c-4' },
    { id: 'PAY777888999', name: 'Emeka Chukwu', phone: '08077788899', colorClass: 'c-5' },
];

// Mock active circles (for blocking duplicate frequency)
const activeCircles = ['weekly']; // User already has an active weekly circle

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    checkFrequencyBlocks();
});

function checkFrequencyBlocks() {
    activeCircles.forEach(freq => {
        const opt = document.querySelector(`.freq-opt[data-freq="${freq}"]`);
        if (opt) {
            opt.classList.add('blocked');
            opt.onclick = () => showToast(`‚ùå You already have an active ${freq} circle`);
        }
    });
}

// Step 1
function selectFreq(el, freq) {
    if (el.classList.contains('blocked')) return;
    document.querySelectorAll('.freq-opt').forEach(o => o.classList.remove('active'));
    el.classList.add('active');
    state.frequency = freq;
}

function validateStep1() {
    const amount = parseFloat(document.getElementById('amount').value);
    const name = document.getElementById('circleName').value.trim();

    if (!amount || amount < 100) {
        showToast('‚ùå Enter amount (min ‚Ç¶100)');
        return;
    }
    if (!name) {
        showToast('‚ùå Enter circle name');
        return;
    }

    state.amount = amount;
    state.circleName = name;
    goToStep(2);
}

// Step 2: Members
function searchMembers(query) {
    const results = document.getElementById('searchResults');
    if (!query.trim()) {
        results.style.display = 'none';
        return;
    }

    const filtered = mockUsers.filter(u => 
        !state.members.find(m => m.id === u.id) &&
        (u.name.toLowerCase().includes(query.toLowerCase()) || u.id.toLowerCase().includes(query.toLowerCase()))
    );

    if (filtered.length === 0) {
        results.innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">No users found</div></div>';
        results.style.display = 'block';
        return;
    }

    results.innerHTML = filtered.map(u => `
        <div class="user-card" onclick='addMember(${JSON.stringify(u)})'>
            <div class="member-avatar ${u.colorClass}">${getInitials(u.name)}</div>
            <div class="member-info">
                <div class="member-name">${u.name}</div>
                <div class="member-id">${u.id}</div>
            </div>
        </div>
    `).join('');
    results.style.display = 'block';
}

function addMember(user) {
    if (typeof user === 'string') user = JSON.parse(user);
    
    if (state.members.length >= 12) {
        showToast('‚ùå Maximum 12 members');
        return;
    }

    state.members.push(user);
    document.getElementById('memberSearch').value = '';
    document.getElementById('searchResults').style.display = 'none';
    renderMembers();
    updateContinueBtn();
}

function removeMember(index) {
    state.members.splice(index, 1);
    renderMembers();
    updateContinueBtn();
}

function renderMembers() {
    const list = document.getElementById('membersList');
    document.getElementById('memberCount').textContent = state.members.length;

    if (state.members.length === 0) {
        list.innerHTML = '<div class="empty"><div class="empty-icon">üë•</div><div class="empty-text">Add 3-12 members to continue</div></div>';
        return;
    }

    list.innerHTML = state.members.map((m, i) => `
        <div class="member-item" draggable="true" ondragstart="dragStart(event, ${i})" ondragover="dragOver(event)" ondrop="drop(event, ${i})">
            <span class="drag-handle">‚ò∞</span>
            <div class="member-avatar ${m.colorClass}">${getInitials(m.name)}</div>
            <div class="member-info">
                <div class="member-name">${m.name}</div>
                <div class="member-id">#${i+1} in order</div>
            </div>
            <button class="remove-btn" onclick="removeMember(${i})">√ó</button>
        </div>
    `).join('');
}

function updateContinueBtn() {
    document.getElementById('continueBtn2').disabled = state.members.length < 3;
}

// Drag & drop
let draggedIndex = null;

function dragStart(e, index) {
    draggedIndex = index;
    e.target.classList.add('dragging');
}

function dragOver(e) {
    e.preventDefault();
}

function drop(e, dropIndex) {
    e.preventDefault();
    document.querySelectorAll('.member-item').forEach(m => m.classList.remove('dragging'));
    
    if (draggedIndex === null || draggedIndex === dropIndex) return;

    const [removed] = state.members.splice(draggedIndex, 1);
    state.members.splice(dropIndex, 0, removed);
    draggedIndex = null;
    renderMembers();
}

// Step 3: Review
function goToStep(n) {
    if (n === 3) populateReview();
    
    state.step = n;
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(`screen-${n}`).classList.add('active');
    document.getElementById('stepBadge').textContent = `Step ${n}/3`;
}

function populateReview() {
    document.getElementById('reviewName').textContent = state.circleName;
    document.getElementById('reviewAmount').textContent = `‚Ç¶${state.amount.toLocaleString('en-NG')}`;
    document.getElementById('reviewFreq').textContent = state.frequency.charAt(0).toUpperCase() + state.frequency.slice(1);
    document.getElementById('reviewMembers').textContent = state.members.length;
    document.getElementById('reviewCycles').textContent = state.members.length;

    const totalCollected = state.amount * state.members.length;
    const platformFee = Math.floor(totalCollected * 0.02);
    const netPayout = totalCollected - platformFee;

    document.getElementById('feeTotal').textContent = `‚Ç¶${totalCollected.toLocaleString('en-NG')}`;
    document.getElementById('feePlatform').textContent = `‚Ç¶${platformFee.toLocaleString('en-NG')}`;
    document.getElementById('feeNet').textContent = `‚Ç¶${netPayout.toLocaleString('en-NG')}`;
}

function launchCircle() {
    // API: POST /api/ajo/create
    const payload = {
        name: state.circleName,
        amount: state.amount,
        frequency: state.frequency,
        members: state.members.map((m, i) => ({ userId: m.id, position: i + 1 }))
    };

    console.log('Creating circle:', payload);
    showToast('‚úÖ Circle created! Invitations sent.');
    
    setTimeout(() => {
        window.location.href = 'ajo-home.html';
    }, 1500);
}

function goBack() {
    if (state.step === 1) {
        window.location.href = 'ajo-home.html';
    } else {
        goToStep(state.step - 1);
    }
}

// Utils
function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
}

let toastTimer;
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
